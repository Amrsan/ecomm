<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectroMart - Electronics Store</title>
    <script src="config.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e8ee 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            background: #181c24;
            color: #fff;
            padding: 40px 0 30px 0;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        }
        .logo-svg {
            width: 90px;
            height: 90px;
            margin-bottom: 12px;
            animation: rotate 3s linear infinite;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        @keyframes rotate {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
        h1 {
            margin: 0;
            font-size: 2.7rem;
            letter-spacing: 2px;
            font-weight: 700;
        }
        .subtitle {
            color: #b0b8c1;
            font-size: 1.15rem;
            margin-top: 7px;
            letter-spacing: 0.5px;
        }
        .products {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 36px;
            padding: 50px 20px 60px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .product-card {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.10);
            width: 300px;
            padding: 28px 22px 24px 22px;
            text-align: center;
            transition: transform 0.22s, box-shadow 0.22s, border 0.22s;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
        }
        .product-card:hover {
            transform: translateY(-10px) scale(1.035);
            box-shadow: 0 12px 32px rgba(0,120,215,0.18);
            border: 2px solid #0078d7;
            z-index: 2;
        }
        .product-img {
            margin-top: 10px;
            width: 170px;
            height: 170px;
            object-fit: cover;
            margin-bottom: 20px;
            border-radius: 14px;
            box-shadow: 0 2px 14px rgba(0,0,0,0.11);
            transition: box-shadow 0.22s;
        }
        .product-card:hover .product-img {
            box-shadow: 0 6px 24px rgba(0,120,215,0.18);
        }
        .product-title {
            font-size: 1.35rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #181c24;
            letter-spacing: 0.5px;
        }
        .product-desc {
            font-size: 1.05rem;
            color: #555;
            margin-bottom: 18px;
            min-height: 48px;
        }
        .product-price {
            font-size: 1.22rem;
            color: #0078d7;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .buy-btn {
            background: linear-gradient(90deg, #0078d7 60%, #00ffe7 100%);
            color: #fff;
            border: none;
            border-radius: 9px;
            padding: 12px 34px;
            font-size: 1.08rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(0,120,215,0.08);
        }
        .buy-btn:hover {
            background: linear-gradient(90deg, #005fa3 60%, #00bfae 100%);
            box-shadow: 0 4px 16px rgba(0,120,215,0.18);
        }
        @media (max-width: 1000px) {
            .products {
                gap: 24px;
            }
            .product-card {
                width: 90vw;
                max-width: 400px;
            }
        }
        @media (max-width: 700px) {
            .products {
                flex-direction: column;
                align-items: center;
                padding: 30px 5vw 40px 5vw;
            }
            .product-card {
                width: 100%;
                max-width: 98vw;
            }
        }
        .cart-icon {
            position: absolute;
            top: 32px;
            right: 40px;
            cursor: pointer;
            z-index: 10;
        }
        .cart-icon svg {
            width: 36px;
            height: 36px;
            fill: #fff;
            filter: drop-shadow(0 2px 8px rgba(0,120,215,0.18));
        }
        .cart-count {
            position: absolute;
            top: 24px;
            right: 34px;
            background: #ff0055;
            color: #fff;
            font-size: 0.95rem;
            font-weight: bold;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(255,0,85,0.18);
        }
        .cart-modal, .details-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(24,28,36,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .cart-content, .details-content {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            padding: 32px 28px 24px 28px;
            min-width: 320px;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .cart-content h2, .details-content h2 {
            margin-top: 0;
            margin-bottom: 18px;
            font-size: 1.5rem;
            color: #181c24;
        }
        .cart-item {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 18px;
        }
        .cart-item img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }
        .cart-item-title {
            font-weight: 600;
            color: #222;
        }
        .cart-item-qty {
            margin: 0 8px;
            font-size: 1.1rem;
        }
        .cart-item-remove {
            background: none;
            border: none;
            color: #ff0055;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .cart-total {
            font-weight: bold;
            color: #0078d7;
            margin-top: 10px;
            font-size: 1.15rem;
        }
        .close-modal {
            position: absolute;
            top: 12px;
            right: 18px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #888;
            cursor: pointer;
        }
        .details-img {
            width: 180px;
            height: 180px;
            object-fit: cover;
            border-radius: 14px;
            box-shadow: 0 2px 14px rgba(0,0,0,0.11);
            margin-bottom: 18px;
        }
        .details-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #181c24;
            margin-bottom: 8px;
        }
        .details-desc {
            color: #555;
            margin-bottom: 14px;
        }
        .details-price {
            color: #0078d7;
            font-weight: bold;
            font-size: 1.15rem;
            margin-bottom: 16px;
        }
        .details-buy-btn {
            background: linear-gradient(90deg, #0078d7 60%, #00ffe7 100%);
            color: #fff;
            border: none;
            border-radius: 9px;
            padding: 10px 28px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(0,120,215,0.08);
        }
        .details-buy-btn:hover {
            background: linear-gradient(90deg, #005fa3 60%, #00bfae 100%);
            box-shadow: 0 4px 16px rgba(0,120,215,0.18);
        }
        .admin-btn {
            position: absolute;
            left: 40px;
            top: 32px;
            background: #0078d7;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 22px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            z-index: 10;
        }
        .admin-btn:hover {
            background: #005fa3;
        }
        .admin-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(24,28,36,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.2s;
        }
        .admin-content {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            padding: 32px 28px 24px 28px;
            min-width: 340px;
            max-width: 98vw;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }
        .admin-content h2 {
            margin-top: 0;
            margin-bottom: 18px;
            font-size: 1.4rem;
            color: #181c24;
        }
        .admin-form input, .admin-form textarea {
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
        }
        .admin-form textarea {
            resize: vertical;
            min-height: 40px;
        }
        .admin-form label {
            font-size: 0.98rem;
            color: #222;
            font-weight: 500;
        }
        .admin-form button {
            background: #0078d7;
            color: #fff;
            border: none;
            border-radius: 7px;
            padding: 8px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-right: 8px;
            margin-top: 4px;
        }
        .admin-form button:hover {
            background: #005fa3;
        }
        .admin-products-list {
            margin-top: 18px;
        }
        .admin-product-row {
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #eee;
            padding: 7px 0;
        }
        .admin-product-row img {
            width: 38px;
            height: 38px;
            border-radius: 6px;
            object-fit: cover;
        }
        .admin-product-title {
            flex: 1;
            font-weight: 600;
            color: #222;
            font-size: 1rem;
        }
        .admin-product-actions button {
            background: #ff0055;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 4px 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            margin-left: 4px;
        }
        .admin-product-actions button.edit {
            background: #0078d7;
        }
        .admin-product-actions button.edit:hover {
            background: #005fa3;
        }
        .admin-product-actions button.delete:hover {
            background: #c4003a;
        }
        .checkout-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(24,28,36,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.2s;
        }
        .checkout-content {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            padding: 32px 28px 24px 28px;
            min-width: 340px;
            max-width: 98vw;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }
        .checkout-content h2 {
            margin-top: 0;
            margin-bottom: 18px;
            font-size: 1.4rem;
            color: #181c24;
        }
        .checkout-form label {
            font-size: 0.98rem;
            color: #222;
            font-weight: 500;
            display: block;
            margin-bottom: 3px;
        }
        .checkout-form input, .checkout-form select {
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
        }
        .checkout-summary {
            background: #f5f7fa;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 14px;
            font-size: 1.05rem;
        }
        .checkout-btns {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .checkout-btns button {
            background: #0078d7;
            color: #fff;
            border: none;
            border-radius: 7px;
            padding: 8px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .checkout-btns button.cancel {
            background: #ff0055;
        }
        .checkout-btns button.cancel:hover {
            background: #c4003a;
        }
        .checkout-btns button:hover {
            background: #005fa3;
        }
        .success-message {
            color: #0078d7;
            font-weight: bold;
            margin-top: 18px;
            text-align: center;
        }
    </style>
</head>
<body>
    <header>
        <!-- <button class="admin-btn" onclick="toggleAdmin()">ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ©</button> -->
        <!-- Animated SVG Logo -->
        <svg class="logo-svg" viewBox="0 0 100 100" fill="none">
            <defs>
                <radialGradient id="logo-gradient" cx="50%" cy="50%" r="50%">
                    <stop offset="0%" stop-color="#0078d7"/>
                    <stop offset="100%" stop-color="#00ffe7"/>
                </radialGradient>
                <filter id="logo-glow" x="-30%" y="-30%" width="160%" height="160%">
                    <feGaussianBlur stdDeviation="6" result="glow"/>
                    <feMerge>
                        <feMergeNode in="glow"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </defs>
            <!-- Outer glowing ring -->
            <circle cx="50" cy="50" r="40" stroke="url(#logo-gradient)" stroke-width="6" filter="url(#logo-glow)">
                <animate attributeName="stroke-dasharray" values="0,251;251,0;0,251" dur="2.5s" repeatCount="indefinite"/>
            </circle>
            <!-- Inner rotating arc -->
            <path d="M50,20 A30,30 0 1,1 49.9,20" stroke="#ff00c8" stroke-width="4" fill="none" filter="url(#logo-glow)">
                <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="2s" repeatCount="indefinite"/>
            </path>
            <!-- Central stylized E letter -->
            <text x="50%" y="56%" text-anchor="middle" fill="#fff" font-size="38" font-family="Segoe UI, Arial, sans-serif" font-weight="bold" filter="url(#logo-glow)">
                <tspan>
                    E
                </tspan>
                <animate attributeName="fill" values="#fff;#00ffe7;#fff" dur="2s" repeatCount="indefinite"/>
            </text>
        </svg>
        <div class="cart-icon" onclick="openCart()">
            <svg viewBox="0 0 24 24"><path d="M7 20c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2zm10 0c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2zM7.334 17h9.332c.828 0 1.554-.522 1.847-1.303l3.487-8.717A1 1 0 0 0 21 6H6.21l-.94-2.342A1 1 0 0 0 4.342 2H1a1 1 0 1 0 0 2h2.342l3.6 8.977-1.35 2.45C4.52 16.09 5.477 17 6.667 17zM6.16 12l1.1-2h10.45l-2.7 6.75a.5.5 0 0 1-.47.25H7.334a.5.5 0 0 1-.47-.25L6.16 12z"/></svg>
            <span class="cart-count" id="cart-count">0</span>
        </div>
        <h1>ElectroMart</h1>
        <div class="subtitle">Your one-stop shop for laptops, keyboards, mouses, and more</div>
    </header>
    <section class="products" id="products-list">
        <!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ≥ÿ™ÿ∂ÿßŸÅ ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
    </section>
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ≥ŸÑÿ© -->
    <div class="cart-modal" id="cart-modal" style="display:none;">
        <div class="cart-content">
            <button class="close-modal" onclick="closeCart()">&times;</button>
            <h2>Shopping Cart</h2>
            <div id="cart-items"></div>
            <div class="cart-total" id="cart-total"></div>
        </div>
    </div>
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ -->
    <div class="details-modal" id="details-modal" style="display:none;">
        <div class="details-content" id="details-content">
            <!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ≥ÿ™ÿ∂ÿßŸÅ ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
        </div>
    </div>
    <!-- ŸÜÿßŸÅÿ∞ÿ© ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ© -->
    <div class="admin-modal" id="admin-modal" style="display:none;">
        <div class="admin-content">
            <button class="close-modal" onclick="toggleAdmin()">&times;</button>
            <h2>ŸÑŸàÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</h2>
            <div style="margin-bottom: 20px; padding: 10px; background: #f5f7fa; border-radius: 8px;">
                <button type="button" onclick="testAPIConnection()" style="background: #0078d7; color: #fff; border: none; border-radius: 6px; padding: 8px 16px; margin-right: 10px; cursor: pointer;">Test API Connection</button>
                <button type="button" onclick="console.log('Current products:', products)" style="background: #28a745; color: #fff; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">Log Products</button>
            </div>
            <form class="admin-form" id="admin-form" onsubmit="return saveProduct(event)">
                <input type="hidden" id="admin-id">
                <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨</label>
                <input type="text" id="admin-title" required>
                <label>ÿßŸÑŸàÿµŸÅ ÿßŸÑŸÖÿÆÿ™ÿµÿ±</label>
                <input type="text" id="admin-desc" required>
                <label>ÿßŸÑÿ≥ÿπÿ± (ÿØŸàŸÑÿßÿ±)</label>
                <input type="number" id="admin-price" min="1" required>
                <label>ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©</label>
                <input type="url" id="admin-image" required>
                <label>ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨</label>
                <textarea id="admin-details" required></textarea>
                <button type="submit" id="admin-save-btn">ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨</button>
                <button type="button" onclick="resetAdminForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
            </form>
            <div class="admin-products-list" id="admin-products-list"></div>
        </div>
    </div>
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿµŸÅÿ≠ÿ© ÿßŸÑÿØŸÅÿπ -->
    <div class="checkout-modal" id="checkout-modal" style="display:none;">
        <div class="checkout-content">
            <button class="close-modal" onclick="closeCheckout()">&times;</button>
            <h2>Checkout</h2>
            <form class="checkout-form" id="checkout-form" onsubmit="return confirmCheckout(event)">
                <div class="checkout-summary" id="checkout-summary"></div>
                <label>Full Name</label>
                <input type="text" id="checkout-name" required>
                <label>Address</label>
                <input type="text" id="checkout-address" required>
                <label>Payment Method</label>
                <select id="checkout-payment" required>
                    <option value="cash">Cash</option>
                    <option value="debit">Debit Card</option>
                </select>
                <label>Shipping Method</label>
                <select id="checkout-shipping" onchange="updateCheckoutSummary()" required>
                    <option value="normal">Normal Shipping (Free)</option>
                    <option value="fast">Fast Shipping (+$3)</option>
                </select>
                <div class="checkout-btns">
                    <button type="submit">Confirm Order</button>
                    <button type="button" class="cancel" onclick="closeCheckout()">Cancel</button>
                </div>
            </form>
            <div class="success-message" id="checkout-success" style="display:none;"></div>
        </div>
    </div>
   <script>
    // =================================================================
    // CONFIG AND GLOBAL STATE
    // =================================================================
    const API_BASE_URL = CONFIG.API_BASE_URL;
    const API_ENDPOINTS = CONFIG.ENDPOINTS;
    const SUPABASE_KEY = CONFIG.AUTH.apiKey;

    let products = [];
    let cart = [];

    // =================================================================
    // API HELPER FUNCTIONS
    // =================================================================
    async function apiRequest(endpoint, options = {}) {
        const url = `${API_BASE_URL}${endpoint}`;
        const headers = {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            ...options.headers
        };
        const config = { ...options, headers };

        if (CONFIG.DEBUG.enabled && CONFIG.DEBUG.logRequests) {
            console.log('üåê API Request:', { url, method: config.method || 'GET' });
        }

        try {
            const response = await fetch(url, config);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
            }
            if (response.status === 204) return null;
            
            const data = await response.json();
            if (CONFIG.DEBUG.enabled && CONFIG.DEBUG.logResponses) {
                console.log('‚úÖ API Success Response:', data);
            }
            return data;
        } catch (error) {
            console.error('‚ùå API request failed:', { url, error: error.message });
            throw error;
        }
    }

    // =================================================================
    // PRODUCT API FUNCTIONS (CRUD)
    // =================================================================
    function fetchProducts() {
        return apiRequest(`${API_ENDPOINTS.products}?select=*&order=id.asc`);
    }

    function createProduct(productData) {
        return apiRequest(API_ENDPOINTS.products, {
            method: 'POST',
            headers: { 'Prefer': 'return=representation' }, 
            body: JSON.stringify(productData)
        });
    }

    function updateProduct(productId, productData) {
        return apiRequest(`${API_ENDPOINTS.products}?id=eq.${productId}`, {
            method: 'PATCH',
            headers: { 'Prefer': 'return=representation' },
            body: JSON.stringify(productData)
        });
    }

    function deleteProduct(productId) {
        return apiRequest(`${API_ENDPOINTS.products}?id=eq.${productId}`, {
            method: 'DELETE'
        });
    }
    
    function createOrder(orderData) {
        return apiRequest(API_ENDPOINTS.orders, {
            method: 'POST',
            headers: { 'Prefer': 'return=representation' },
            body: JSON.stringify(orderData)
        });
    }

    // =================================================================
    // UI RENDERING AND INITIALIZATION
    // =================================================================
    async function initializeProducts() {
        console.log('üöÄ Initializing products from Supabase...');
        try {
            products = await fetchProducts();
            console.log('‚úÖ Products loaded from API:', products.length, 'items');
            renderProducts();
            renderAdminProducts();
        } catch (error) {
            console.error('‚ùå Failed to load products from API.', error);
            document.getElementById('products-list').innerHTML = '<p style="color:red; text-align:center;">Could not load products.</p>';
        }
    }
    
    function renderProducts() {
        const productsList = document.getElementById('products-list');
        productsList.innerHTML = '';
        products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            // All onclick handlers now correctly wrap the string ID in quotes
            card.innerHTML = `
                <img class="product-img" src="${product.image}" alt="${product.title}">
                <div class="product-title">${product.title}</div>
                <div class="product-desc">${product.description}</div>
                <div class="product-price">$${product.price}</div>
                <button class="buy-btn" onclick="showDetails(product.id);event.stopPropagation();">Buy Now</button>
            `;
            card.onclick = () => showDetails(product.id);
            productsList.appendChild(card);
        });
    }

    // =================================================================
    // CART LOGIC (CORRECTED & DE-DUPLICATED)
    // =================================================================
    function addToCart(id) {
        console.log(`üõí addToCart called with id: ${id}`);
        if (typeof id !== 'string' || id.length === 0) {
            console.error("Invalid product ID passed to addToCart:", id);
            return;
        }

        const idx = cart.findIndex(item => item.id === id); // String comparison
        if (idx > -1) {
            cart[idx].qty++;
        } else {
            cart.push({ id: id, qty: 1 });
        }
        updateCartCount();
    }

    function updateCartCount() {
        const cartCountElement = document.getElementById('cart-count');
        if (!cartCountElement) return;
        cartCountElement.textContent = cart.reduce((total, item) => total + item.qty, 0);
    }
    
    function changeQty(id, delta) {
        const idx = cart.findIndex(item => item.id === id); // String comparison
        if (idx > -1) {
            cart[idx].qty += delta;
            if (cart[idx].qty <= 0) {
                cart.splice(idx, 1);
            }
            updateCartCount();
            openCart(); // Refresh cart view
        }
    }

    function removeFromCart(id) {
        cart = cart.filter(item => item.id !== id); // String comparison
        updateCartCount();
        openCart(); // Refresh cart view
    }

    function openCart() {
        const modal = document.getElementById('cart-modal');
        const itemsDiv = document.getElementById('cart-items');
        itemsDiv.innerHTML = '';
        let total = 0;

        if (cart.length === 0) {
            itemsDiv.innerHTML = '<div style="color:#888;">Cart is empty.</div>';
        } else {
            cart.forEach(cartItem => {
                const productDetails = products.find(p => p.id === cartItem.id);
                if (productDetails) {
                    total += productDetails.price * cartItem.qty;
                    itemsDiv.innerHTML += `
                    <div class="cart-item">
                        <img src="${productDetails.image}" alt="${productDetails.title}">
                        <span class="cart-item-title">${productDetails.title}</span>
                        <button onclick="changeQty('${cartItem.id}',-1);event.stopPropagation();">-</button>
                        <span class="cart-item-qty">${cartItem.qty}</span>
                        <button onclick="changeQty('${cartItem.id}',1);event.stopPropagation();">+</button>
                        <button class="cart-item-remove" onclick="removeFromCart('${cartItem.id}');event.stopPropagation();">&times;</button>
                    </div>`;
                }
            });
            if (total > 0) {
                itemsDiv.innerHTML += `<div style="margin-top:18px;text-align:right;"><button onclick="openCheckout()" style="background:#0078d7;color:#fff;border:none;border-radius:7px;padding:10px 28px;font-size:1.05rem;font-weight:600;cursor:pointer;">Checkout</button></div>`;
            }
        }
        document.getElementById('cart-total').textContent = cart.length ? `Total: $${total.toFixed(2)}` : '';
        modal.style.display = 'flex';
    }

    function closeCart() {
        document.getElementById('cart-modal').style.display = 'none';
    }

    // =================================================================
    // MODALS (DETAILS, ADMIN, CHECKOUT)
    // =================================================================
    function showDetails(id) {
        const prod = products.find(p => p.id === id);
        if (!prod) return;
        const modal = document.getElementById('details-modal');
        const content = document.getElementById('details-content');
        const detailsText = prod.details || prod.description;
        // ** THE CRITICAL FIX IS HERE **: onclick="addToCart('${prod.id}')" now has quotes.
        content.innerHTML = `
            <button class="close-modal" onclick="closeDetails()">&times;</button>
            <img class="details-img" src="${prod.image}" alt="${prod.title}">
            <div class="details-title">${prod.title}</div>
            <div class="details-desc">${detailsText}</div>
            <div class="details-price">$${prod.price}</div>
            <button class="details-buy-btn" onclick="addToCart('${prod.id}');closeDetails();">Add to Cart</button>
        `;
        modal.style.display = 'flex';
    }

    function closeDetails() {
        document.getElementById('details-modal').style.display = 'none';
    }

    function toggleAdmin() {
        const modal = document.getElementById('admin-modal');
        modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        if (modal.style.display === 'flex') {
            renderAdminProducts();
        }
    }

    function renderAdminProducts() {
        const list = document.getElementById('admin-products-list');
        list.innerHTML = '';
        products.forEach(prod => {
            list.innerHTML += `
            <div class="admin-product-row">
                <img src="${prod.image}" alt="img">
                <span class="admin-product-title">${prod.title}</span>
                <div class="admin-product-actions">
                    <button class="edit" onclick="editProduct('${prod.id}')">ÿ™ÿπÿØŸäŸÑ</button>
                    <button class="delete" onclick="confirmDelete('${prod.id}')">ÿ≠ÿ∞ŸÅ</button>
                </div>
            </div>`;
        });
    }

    async function saveProduct(e) {
        e.preventDefault();
        const id = document.getElementById('admin-id').value;
        const productData = {
            title: document.getElementById('admin-title').value,
            description: document.getElementById('admin-desc').value,
            price: parseFloat(document.getElementById('admin-price').value),
            image: document.getElementById('admin-image').value,
            category: 'Electronics',
            details: document.getElementById('admin-details').value
        };

        try {
            if (id) {
                await updateProduct(id, productData);
            } else {
                await createProduct(productData);
            }
            await initializeProducts();
            resetAdminForm();
        } catch (error) {
            alert('Failed to save product. Check console for details.');
        }
    }

    function editProduct(id) {
        const prod = products.find(p => p.id === id); // String comparison
        if (!prod) return;
        document.getElementById('admin-id').value = prod.id;
        document.getElementById('admin-title').value = prod.title;
        document.getElementById('admin-desc').value = prod.description;
        document.getElementById('admin-price').value = prod.price;
        document.getElementById('admin-image').value = prod.image;
        document.getElementById('admin-details').value = prod.details || prod.description;
        document.getElementById('admin-save-btn').textContent = 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™';
    }

    async function confirmDelete(id) {
        if (!confirm('Are you sure you want to delete this product?')) return;
        try {
            await deleteProduct(id); // Pass string ID directly
            await initializeProducts();
        } catch (error) {
            alert('Failed to delete product. Check console for details.');
        }
    }
    
    function resetAdminForm() {
        document.getElementById('admin-form').reset();
        document.getElementById('admin-id').value = '';
        document.getElementById('admin-save-btn').textContent = 'ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨';
    }
    
    function openCheckout() {
    document.getElementById('checkout-modal').style.display = 'flex';
    updateCheckoutSummary();
}


    function closeCheckout() {
        document.getElementById('checkout-modal').style.display = 'none';
    }
    function updateCheckoutSummary() {
        let total = 0;
        let summary = '';
        if(cart.length === 0) {
            summary = '<div style="color:#888;">Cart is empty.</div>';
        } else {
            summary += '<b>Order Summary:</b><ul style="margin:8px 0 8px 18px;padding:0;">';
            cart.forEach(item => {
                const prod = products.find(p=>p.id===item.id);
                if (!prod) return;
                total += prod.price * item.qty;
                summary += `<li>${prod.title} x ${item.qty} = $${(prod.price * item.qty).toFixed(2)}</li>`;
            });
            summary += '</ul>';
        }
        // Shipping
        const shipping = document.getElementById('checkout-shipping').value;
        if(shipping === 'fast') {
            summary += '<div>Fast Shipping: <b>$3.00</b></div>';
            total += 3;
        } else {
            summary += '<div>Normal Shipping: <b>Free</b></div>';
        }
        summary += `<div style="margin-top:8px;">Total: <b>$${total.toFixed(2)}</b></div>`;
        document.getElementById('checkout-summary').innerHTML = summary;

        console.log(`Shipping: ${shipping}, Total with shipping: $${total.toFixed(2)}`);

    }
    function updateCheckoutTotal() {
        updateCheckoutSummary();
    }
    async function confirmCheckout(e) {
    e.preventDefault();

    // Gather data from the form and cart
    const name = document.getElementById('checkout-name').value;
    const address = document.getElementById('checkout-address').value;
    const payment = document.getElementById('checkout-payment').value;
    const shipping = document.getElementById('checkout-shipping').value;

    // Prepare order items array
    const items = cart.map(item => {
        const prod = products.find(p => p.id === item.id);
        return {
            product_id: item.id,
            title: prod ? prod.title : '',
            price: prod ? prod.price : 0,
            quantity: item.qty
        };
    });

    let total = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
    if(shipping === 'fast') total += 3;

    // Prepare order data
    const orderData = {
        customer_name: name,
        address: address,
        payment_method: payment,
        shipping_method: shipping,
        total: total,
        items: items, // Store as JSON
        product_name: items.length === 1 ? items[0].title : 'Multiple Items'
    };

    // Actually save to DB
    try {
        await createOrder(orderData); // <-- This saves order in Supabase
        document.getElementById('checkout-success').innerHTML =
            `Thank you, <b>${name}</b>!<br>Your order has been placed.<br><br><b>Address:</b> ${address}<br><b>Payment:</b> ${payment === 'cash' ? 'Cash' : 'Debit Card'}<br><b>Shipping:</b> ${shipping === 'fast' ? 'Fast ($3)' : 'Normal (Free)'}<br><b>Total:</b> $${total}`;
        document.getElementById('checkout-success').style.display = 'block';
        cart = [];
        updateCartCount();
        setTimeout(()=>{
            closeCheckout();
        }, 3500);
    } catch (err) {
        alert('Sorry, there was a problem placing your order. Please try again.');
        console.error(err);
    }
    return false;
}

    // ÿπŸÜÿØ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸÅÿπÿå ÿ≠ÿØÿ´ ŸÖŸÑÿÆÿµ ÿßŸÑÿ∑ŸÑÿ®
    document.getElementById('checkout-shipping').addEventListener('change', updateCheckoutSummary);

    // =================================================================
    // EVENT LISTENERS
    // =================================================================
    window.onclick = function(e) {
        if (e.target.id === 'cart-modal') closeCart();
        if (e.target.id === 'details-modal') closeDetails();
        if (e.target.id === 'admin-modal') toggleAdmin();
        if (e.target.id === 'checkout-modal') closeCheckout();
    }

    document.addEventListener('DOMContentLoaded', initializeProducts);
</script>

</body>
</html>
